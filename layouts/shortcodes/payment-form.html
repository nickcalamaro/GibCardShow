<style>
.ticket-btn {
width: 100%;
padding: 0.5rem 1rem;
font-weight: 500;
border-radius: 0.375rem;
border: 2px solid transparent;
transition: all 0.2s ease;
position: relative;
color: white;
}
.ticket-btn:not(:disabled) {
background: linear-gradient(to right, black, #ef4444);
border-color: black;
box-shadow: 0 2px 4px rgba(0,0,0,0.3);
cursor: pointer;
}
.ticket-btn:not(:disabled):hover { opacity: 0.9; }
.ticket-btn:disabled {
background-color: #d1d5db;
border-color: #9ca3af;
cursor: not-allowed;
box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.tooltip {
position: absolute;
left: 50%;
transform: translateX(-50%);
top: -2.5rem;
padding: 0.25rem 0.5rem;
font-size: 0.75rem;
color: white;
background: black;
border-radius: 0.25rem;
opacity: 0;
pointer-events: none;
transition: opacity 0.2s ease;
white-space: nowrap;
}
.ticket-btn:disabled:hover .tooltip { opacity: 1; }

/* Quantity input styling */

.form-card input[type="number"] {
  background-color: #fff;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  padding: 0.5rem;
  width: 5rem;
  text-align: center;
}

html.dark .form-card input[type="number"] {
  background-color: rgba(40, 40, 40, 0.9);
  border-color: #666;
  color: #fff;
}

/* Quantity selector container */
.quantity-selector {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  margin: 0.5rem 0 1rem;
}

/* Quantity row */
.quantity-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 0.5rem 0 1rem;
}

/* Selector itself */
.quantity-selector {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.quantity-selector button {
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  width: 2rem;
  height: 2rem;
  font-size: 1.25rem;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s ease;
  line-height: 1;
}

.quantity-selector button:hover {
  background: #e5e7eb;
}

.quantity-selector input {
  width: 3.5rem;
  text-align: center;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  padding: 0.25rem;
}

html.dark .quantity-selector button {
  background: rgba(40, 40, 40, 0.9);
  border-color: #666;
  color: #fff;
}
html.dark .quantity-selector input {
  background: rgba(40, 40, 40, 0.9);
  border-color: #666;
  color: #fff;
}


/* Dark mode form container */
html.dark .form-card,
:root.dark .form-card,
[data-theme='dark'] .form-card,
[data-scheme='dark'] .form-card,
[data-color-scheme='dark'] .form-card {
background: rgba(20, 20, 20, 0.85) !important;
color: #fff !important;
}
/* Dark mode labels and text */
html.dark .form-card label span,
:root.dark .form-card label span,
[data-theme='dark'] .form-card label span { color: #fff !important; }
/* Dark mode checkboxes */
html.dark .form-card input[type="checkbox"],
:root.dark .form-card input[type="checkbox"] {
background-color: rgba(40, 40, 40, 0.9);
border-color: #666;
}
/* Dark mode inputs */
html.dark .form-card input[type="text"],
html.dark .form-card input[type="email"],
:root.dark .form-card input[type="text"],
:root.dark .form-card input[type="email"] {
background-color: rgba(40, 40, 40, 0.9);
border-color: #666;
color: #fff;
}
</style>

<div class="form-card w-full max-w-md mx-auto pt-2 px-6 pb-6 bg-white/90 backdrop-blur rounded-lg shadow-lg">
<h2 id="formHeading" class="text-lg font-semibold text-center text-white bg-gradient-to-r from-black to-red-500 py-3 rounded-md mb-6">
üéüÔ∏è Buy Your Tickets
</h2>

<form id="paymentForm" class="space-y-4" autocomplete="off">
<label class="block">
<span class="text-sm font-medium text-gray-700 dark:text-gray-200">Your Name</span>
<input type="text" name="name" required autocomplete="name"
class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-neutral-800 dark:text-white focus:border-red-500 focus:ring-red-500 sm:text-sm" />
</label>

<label class="block pb-4">
<span class="text-sm font-medium text-gray-700 dark:text-gray-200">Your Email</span>
<input type="email" name="email" required autocomplete="email"
class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-neutral-800 dark:text-white focus:border-red-500 focus:ring-red-500 sm:text-sm" />
</label>

<input type="hidden" name="service" id="service">

<div class="quantity-row">
  <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Number of Tickets</span>
  <div class="quantity-selector">
    <button type="button" id="decreaseQty">‚àí</button>
    <input type="number" name="quantity" id="quantity" value="1" min="1"
      class="dark:border-gray-600 dark:bg-neutral-800 dark:text-white focus:border-red-500 focus:ring-red-500 sm:text-sm" />
    <button type="button" id="increaseQty">+</button>
  </div>
</div>

<label class="flex items-start space-x-2 pb-2">
<input type="checkbox" id="privacyConsent" name="privacyConsent" autocomplete="off"
class="mt-1 h-5 w-5 rounded-md border-gray-300 dark:border-gray-600 text-red-500 focus:ring-red-500">
<span class="text-sm text-gray-700 dark:text-gray-200">
I have read and accept the <a href="/privacy-policy" target="_blank" class="text-red-500 underline">privacy policy</a>.
</span>
</label>

<label class="flex items-start space-x-2 pb-4">
<input type="checkbox" id="marketingConsent" name="marketingConsent" autocomplete="off"
class="mt-1 h-5 w-5 rounded-md border-gray-300 dark:border-gray-600 text-red-500 focus:ring-red-500">
<span class="text-sm text-gray-700 dark:text-gray-200">
I would like to receive marketing communications from Gibraltar Card Show.
</span>
</label>

<button id="submitBtn" type="submit" disabled class="ticket-btn group">
Proceed to Payment
<span id="tooltip" class="tooltip">Please accept the Privacy Policy to proceed</span>
</button>
</form>
</div>

<script>
(function(){
  function init() {
    const params = new URLSearchParams(window.location.search);
    const serviceFromURL = params.get('service');
    if (serviceFromURL) {
      document.getElementById('service').value = serviceFromURL;
      document.getElementById('formHeading').textContent = `üéüÔ∏è ${serviceFromURL}`;
    }

    const privacyCheckbox = document.getElementById('privacyConsent');
    const marketingCheckbox = document.getElementById('marketingConsent');
    const submitBtn = document.getElementById('submitBtn');
    const tooltip = document.getElementById('tooltip');

    // ‚úÖ Only reset the checkboxes, leave other fields alone
    if (privacyCheckbox) privacyCheckbox.checked = false;
    if (marketingCheckbox) marketingCheckbox.checked = false;

    // Quantity controls
    const qtyInput = document.getElementById('quantity');
    const decBtn = document.getElementById('decreaseQty');
    const incBtn = document.getElementById('increaseQty');

    decBtn.addEventListener('click', () => {
      let val = parseInt(qtyInput.value, 10) || 1;
      if (val > 1) qtyInput.value = val - 1;
    });

    incBtn.addEventListener('click', () => {
      let val = parseInt(qtyInput.value, 10) || 1;
      qtyInput.value = val + 1;
    });
// Ensure quantity is at least 1 if manually changed

    updateButtonState();

    function updateButtonState() {
      submitBtn.disabled = !privacyCheckbox.checked;
    }

    submitBtn.addEventListener('click', (e) => {
      if (submitBtn.disabled) {
        e.preventDefault();
        tooltip.style.opacity = 1;
        setTimeout(() => tooltip.style.opacity = 0, 2000);
      }
    });

    privacyCheckbox.addEventListener('change', updateButtonState);

document.getElementById('paymentForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target).entries());

  // Ensure quantity is at least 1
  formData.quantity = Math.max(1, parseInt(formData.quantity, 10) || 1);

  if (!formData.service) {
    alert('No ticket type selected. Please return to the tickets page and choose one.');
    return;
  }

  const res = await fetch('https://sumup-checkout-worker.ncalamaro.workers.dev/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  });

  const data = await res.json();
  if (data.checkout_url) {
    window.location.href = data.checkout_url;
  } else {
    alert(data.error || 'Error creating checkout');
  }
});

}

  // Run on normal load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }

  // Also run when returning via back/forward cache
  window.addEventListener('pageshow', (e) => {
    if (e.persisted || (performance.getEntriesByType && performance.getEntriesByType('navigation')[0]?.type === 'back_forward')) {
      init();
    }
  });
})();
</script>
